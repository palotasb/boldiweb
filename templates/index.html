<!DOCTYPE html>
<html lang="en">
<head>
    <title><j2:var>folder.title</j2:var>
        <j2:block> if folder != album.target_root </j2:block>
            ‚Äì <j2:var>album.title</j2:var>
        <j2:block> endif </j2:block>
    </title>
    <style type="text/css">
/*
  Josh's Custom CSS Reset
  https://www.joshwcomeau.com/css/custom-css-reset/
*/
*, *::before, *::after {
  box-sizing: border-box;
}
* {
  margin: 0;
}
body {
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  font-size: 16px;
  color: black;
  background-color: white;
}
a {
    color: blue;
    text-decoration: underline;
}
a.subtle {
    text-decoration: none;
}
img, picture, video, canvas, svg {
  display: block;
  max-width: 100%;
}
input, button, textarea, select {
  font: inherit;
}
p, h1, h2, h3, h4, h5, h6 {
  overflow-wrap: break-word;
}
#root, #__next {
  isolation: isolate;
}
    </style>
<script type="text/javascript">
function toggleFullscreen() {
  let elem = document.documentElement;

  if (!document.fullscreenElement) {
    elem.requestFullscreen().catch((err) => {
      alert(
        `Error attempting to enable fullscreen mode: ${err.message} (${err.name})`,
      );
    });
  } else {
    document.exitFullscreen();
  }
}

function getFirstVisibleImage() {
    const viewport = window.visualViewport;
    const candidates = document.querySelectorAll("header, article.image");
    let elements = [];
    for (const candidate of candidates) {
        const image = candidate.querySelector("picture") || candidate;
        const rect = image.getBoundingClientRect();
        // Check if the candidate vertically overlaps with the viewport
        if (rect.top <= viewport.offsetTop + viewport.height && viewport.offsetTop <= rect.bottom) {
            return candidate;
        }
    }
}

let throttledPushState = null;

document.addEventListener("scroll", (event) => {
  const targetUrl = `#${getFirstVisibleImage().id}`;

  if (window.location.hash !== targetUrl) {
    clearTimeout(throttledPushState); // Clear any existing timeout

    if (!throttledPushState || throttledPushState.fired) {
      window.history.replaceState(null, null, targetUrl);
      throttledPushState = { fired: true }; // Mark the timeout as fired
    } else {
      throttledPushState = setTimeout(() => {
        window.history.replaceState(null, null, targetUrl);
        throttledPushState.fired = true; // Mark the timeout as fired
      }, 1000); // 1000 milliseconds = 1 second
    }
  }
});

document.addEventListener("keydown", (event) => {
  const currentImage = document.querySelector(`article.image${window.location.hash}`) || document.querySelector("article.image");
  if (event.key === "ArrowDown" || event.key === "ArrowRight" || event.key === " " && !event.shiftKey) {
    const images = document.querySelectorAll("article.image");
    for (let i = 0; i < images.length; i++) {
      if (images[i] === currentImage) {
        const nextSibling = images[i + 1];
        if (nextSibling) {
          nextSibling.scrollIntoView({ behavior: "smooth" });
        }
        event.preventDefault();
        return false;
      }
    }
  }
  if (event.key === "ArrowUp" || event.key === "ArrowLeft" || event.key === " " && event.shiftKey) {
    const images = document.querySelectorAll("article.image");
    for (let i = 0; i < images.length; i++) {
      if (images[i] === currentImage) {
        const prevSibling = images[i - 1];
        if (prevSibling) {
          prevSibling.scrollIntoView({ behavior: "smooth" });
        }
        event.preventDefault();
        return false;
      }
    }
  }
});


</script>
</head>
<body>
    <header id="">
        <h1><j2:var>folder.title</j2:var></h1>
        <nav>
        <j2:block> for parent in folder.parents + [folder] </j2:block>
            <a href="<j2:var> parent.path | relative_to(folder.path) </j2:var>/index.html"><j2:var>parent.title</j2:var></a>
            <j2:var> "‚Üí" if not loop.last else "" </j2:var>
        <j2:block> endfor </j2:block>
        </nav>
    </header>

    <ul id="folders">
    <j2:block> for subfolder in folder.subfolders.values() </j2:block>
        <li><a href="<j2:var>subfolder.path | relative_to(folder.path)</j2:var>/index.html"><j2:var>subfolder.title</j2:var></a></li>
    <j2:block> endfor </j2:block>
    </ul>
    
    <main id="images" style="max-width: 100%">
    <j2:block> for name, image in folder.images.items() </j2:block>
        <article class="image" id="<j2:var> image.path.stem </j2:var>">
            <picture style="display: block;">
                <img class="thumbnail"
                    src="<j2:var>image.path | relative_to(folder.path)</j2:var>"
                    alt="<j2:var>image.exif.IPTC.Artist</j2:var>" />
            </picture>
            <h2><a href="#<j2:var> image.path.stem </j2:var>"><j2:var>image.title</j2:var>
                <j2:block> if image.title != image.source.path.stem </j2:block>
                <small>[<j2:var>image.path.stem</j2:var>]</small>
                <j2:block> endif </j2:block>
            </a></h2>
            <p class="image-description">
                <j2:var>image.description or undefined</j2:var>
            </p>
            <p class="exposure-info">
                f = <j2:var>image.focal_length | human_round or "?"</j2:var>mm
                (<j2:var>image.focal_length_35mm | human_round or "?"</j2:var>mm <small>FOV at 35mm equiv.</small>),
                ùëì/<j2:var>image.aperture | human_round or "?"</j2:var>,
                <j2:var>image.shutter_speed | human_round or "?"</j2:var>s,
                ISO <j2:var>image.iso | human_round or "?"</j2:var>,
                LV <j2:var>image.light_value | human_round or "?"</j2:var>
            </p>
            <p class="camera-info">
                <j2:var>image.camera</j2:var> <j2:var> "+" if image.camera and image.lens else "" </j2:var>
                <j2:var>image.lens</j2:var>
            </p>
            <p>
                <a href="#top" class="subtle">‚áß <j2:var> folder.title </j2:var></a> |
                <a href="javascript:toggleFullscreen()" class="subtle"><span>üì∫ </span>Full screen</a>
            </p>
        </article>
    <j2:block> endfor </j2:block>
    </main>
</body>
</html>
